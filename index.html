<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bharath Radio</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#317EFB" />
  <link rel="icon" href="icons/icon-192.png">
  <style>
    body {
      background: #8399ab;
      font-family: 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .ipod {
      width: 320px;
      height: 620px;
      background: linear-gradient(to bottom, #333, #111);
      border-radius: 40px;
      box-shadow: inset 0 0 10px #000, 0 10px 30px rgba(0, 0, 0, 0.7);
      padding: 20px;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .screen {
      background: #000;
      border-radius: 20px;
      width: 100%;
      height: 180px;
      padding: 15px;
      box-shadow: inset 0 0 10px #000;
      text-align: center;
      margin-bottom: 30px;
    }
    .frequency {
      font-size: 32px;
      color: #00aaff;
      font-weight: bold;
    }
    .station {
      font-size: 13px;
      color: #aaa;
      margin-top: 5px;
    }
    .indicator {
      margin-top: 8px;
      height: 10px;
      width: 10px;
      border-radius: 50%;
      background: gray;
      display: inline-block;
    }
    .indicator.on {
      background: limegreen;
      box-shadow: 0 0 10px lime;
    }
    #visualizer {
      margin-top: 12px;
      width: 100%;
      height: 70px;
      background: #111;
      border-radius: 8px;
    }
    .wheel {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      background: #222;
      border: 4px solid #555;
      position: relative;
      box-shadow: inset 0 0 20px #000;
      margin-top: 10px;
    }
    .wheel button {
      position: absolute;
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
    .top-btn { top: 10px; left: 50%; transform: translateX(-50%); }
    .bottom-btn { bottom: 10px; left: 50%; transform: translateX(-50%); }
    .left-btn { left: 10px; top: 50%; transform: translateY(-50%); }
    .right-btn { right: 10px; top: 50%; transform: translateY(-50%); }
    .center-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #555, #000);
      border: none;
      color: red;
      box-shadow:
        inset -3px -3px 6px rgba(255,255,255,0.2),
        inset 3px 3px 6px rgba(0,0,0,0.6),
        0 0 15px red;
      text-shadow: 0 0 5px rgba(255, 0, 0, 0.7);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .center-button.on {
      color: lime;
      box-shadow:
        inset -3px -3px 6px rgba(255,255,255,0.2),
        inset 3px 3px 6px rgba(0,0,0,0.6),
        0 0 20px lime;
      text-shadow: 0 0 6px limegreen;
    }
    .center-button svg {
      width: 32px;
      height: 32px;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
    }
  </style>
</head>
<body>
  <div class="ipod">
    <div class="screen">
      <div class="frequency" id="frequency">--.- MHz</div>
      <div class="station" id="stationName">OFF</div>
      <div class="indicator" id="indicator"></div>
      <canvas id="visualizer" width="280" height="250"></canvas>
    </div>
    <div class="wheel">
      <button class="left-btn" onclick="prevStation()">⏮</button>
      <button class="right-btn" onclick="nextStation()">⏭</button>
      <button class="center-button" onclick="togglePower()" id="powerBtn">
        <svg viewBox="0 0 24 24">
          <path d="M12 2V12" />
          <path d="M5.5 7A9 9 0 1 0 18.5 7" />
        </svg>
      </button>
    </div>
    <audio id="player" preload="none" crossorigin="anonymous"></audio>
  </div>
  <script>
    const stations = [
      { name: "Radio Mango", freq: "91.9", url: "https://listen.openstream.co/4635/audio" },
      { name: "Suryan FM", freq: "93.5", url: "https://radios.crabdance.com:8002/2" },
      { name: "Radio Mirchi", freq: "98.3", url: "https://playerservices.streamtheworld.com/api/livestream-redirect/NJS_HIN_ESTAAC.m3u8" }
    ];
    let current = 0, isOn = false;
    const player = document.getElementById("player"),
          freqDisplay = document.getElementById("frequency"),
          nameDisplay = document.getElementById("stationName"),
          indicator = document.getElementById("indicator"),
          powerBtn = document.getElementById("powerBtn");
    function loadStation(i) {
      const s = stations[i];
      player.src = s.url;
      freqDisplay.textContent = s.freq + " MHz";
      nameDisplay.textContent = s.name;
      player.play().catch(err => console.error("Autoplay error:", err));
    }
    function nextStation() { if (!isOn) return; current = (current + 1) % stations.length; loadStation(current); }
    function prevStation() { if (!isOn) return; current = (current - 1 + stations.length) % stations.length; loadStation(current); }
    function togglePower() {
      isOn = !isOn;
      indicator.classList.toggle("on", isOn);
      powerBtn.classList.toggle("on", isOn);
      if (isOn) {
        if (audioContext.state === 'suspended') audioContext.resume();
        loadStation(current);
        drawVisualizer();
      } else {
        player.pause();
        freqDisplay.textContent = "Bharath Radio";
        nameDisplay.textContent = "OFF";
      }
    }
    const canvas = document.getElementById("visualizer"),
          ctx = canvas.getContext("2d"),
          audioContext = new (window.AudioContext || window.webkitAudioContext)(),
          analyser = audioContext.createAnalyser(),
          source = audioContext.createMediaElementSource(player);
    source.connect(analyser); analyser.connect(audioContext.destination); analyser.fftSize = 64;
    const bufferLength = analyser.frequencyBinCount, dataArray = new Uint8Array(bufferLength);
    function drawVisualizer() {
      requestAnimationFrame(drawVisualizer);
      analyser.getByteFrequencyData(dataArray);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const barWidth = canvas.width / bufferLength;
      let x = 0;
      for (let i = 0; i < bufferLength; i++) {
        const barHeight = dataArray[i];
        ctx.fillStyle = `hsl(${(i / bufferLength) * 360}, 100%, 50%)`;
        ctx.fillRect(x, canvas.height - barHeight, barWidth - 1, barHeight);
        x += barWidth;
      }
    }
    // PWA install button
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.createElement('button');
      btn.textContent = 'Install Bharath Radio';
      btn.style = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 24px;background:#317EFB;color:white;border:none;border-radius:5px;z-index:1000;';
      document.body.appendChild(btn);
      btn.addEventListener('click', () => {
        btn.style.display = 'none';
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          deferredPrompt = null;
        });
      });
    });
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('✅ Service Worker registered:', reg))
        .catch(err => console.error('❌ Service Worker error:', err));
    }
  </script>
</body>
</html>